language: groovy
branches:
  except:
    - /^\d+\.\d+\.\d+/
jdk:
  - oraclejdk8
cache:
  directories:
  - "$HOME/.m2"
  - "$HOME/.ivy2"
  - "$HOME/.gradle/caches/"
  - "$HOME/.gradle/wrapper/"
before_install:
  - git config --global user.email "erwan@saagie.com"
  - git config --global user.name "erwan"
  - git remote set-url origin git@github.com:saagie/gradle-saagie-plugin.git
  - git config remote.origin.fetch refs/heads/*:refs/remotes/origin/*
  - openssl aes-256-cbc -K $encrypted_837e0722fe3d_key -iv $encrypted_837e0722fe3d_iv -in keys.tar.enc -out keys.tar -d
  - tar xvf keys.tar
  - mv id_rsa_travis ~/.ssh/id_rsa
  - chmod 600 ~/.ssh/id_rsa
  - cp -fv config ~/.ssh/config
  - echo signing.password=$gpg_pass >> ~/.gradle/gradle.properties
  - echo nexusName=$SONATYPE_USERNAME >> ~/.gradle/gradle.properties
  - echo nexusPassword=$SONATYPE_PASSWORD >> ~/.gradle/gradle.properties
  - echo gradle.publish.key=$GRADLE_PUBLISH_KEY >> ~/.gradle/gradle.properties
  - echo gradle.publish.secret=$GRADLE_PUBLISH_KEY >> ~/.gradle/gradle.properties
  - wget http://services.gradle.org/distributions/gradle-3.5-bin.zip
  - unzip gradle-3.5-bin.zip
  - export GRADLE_HOME=$PWD/gradle-3.5
  - export PATH=$GRADLE_HOME/bin:$PATH
script:
  - gradle test --stacktrace
  - if [ ${TRAVIS_BRANCH} = "master" ]; then
      git checkout master;
      gradle release -Prelease.useAutomaticVersion=true --stacktrace;
      gradle closeAndReleaseRepository;
    else
      gradle uploadArchive --stacktrace;
    fi
env:
  global:
  - secure: lq8Na892LjfpLD642K36luhbhqAyz9LN0v0tIvXBF6SpNqLcym+oZYShs4FD2IB0+UI6KPqjhWbH82ebZjjo7on7wb0p/q+BO03b0ND7VQL0XkorgfDqIUUaKsxBTv6u52p7D0Pj+STIpiwv/UMjxL61Kbo7aSONcXemwnn7uFJzenl/7PaqvQNMTbNaHIa8RzHV3Rt/lv0Vv3ixyhfw84cAlqrh/9stkGJG0UsHKG+wWeXjOVOA0BXx61XT2KyVoRVfmMC2W9ubyADxw/cZ2A+ekejUuebCpn0w0wptWYOluk+uLmSgW4TNkqnPHRi9RIgcOOVqlH5e8bE2aqsNO6EJ471e4KQqLzjiWkHLXisHPtyYiMke9M2ubCBwchI6qLt7AswlShgunDD3FoVdnYMmvz0Odql0dyfdgtI7kuA8ub/AS8JEBs0wVeGv/S2Z2fL+0jdbGH7DQgrFeAulQaXIwLaxb1ai0d3ly03Hq7FBOhj8LOD8/MsqDrBXmv/cxgnTNSdA5I4LFMfLPSeuZ4mtPGoc23BbDnUGbTLzglplVyHPGortsfyxWl7JtrfNZeGs87BkQDRRmsgq5XYwB07tdzvPSDXHVyC3r9ZxwCNyqtFoxyY1ePZX6I9aflsQXvkQTt8bGtqyHUPU7qCCRFCNB+/tp1o6wPwQD64NYgI=
  - secure: Fp1tmexIPJ9GJQzXh4qiJRaku3+rhGNi23/9Nk3h8Dp1o23exjV6rGWWWDneD9U60JD6HCbjpSLWdNJyvt89VTXksDk8MHLbjzzKE1/EimxeN76Rjp4ilQHiH8eCX0JCzNyJbFFkeMGiWIaYsv2SEOHAZtdQFXnlFDJ9rsReZsU6IO6y83V8DugcLp6xmHNh0UvqE81fg89WT+Hd//TjvH5TJQMIkj4BI6AzNiMlUoro/NqI8yZfzQtOWl/vtRheqbN9BZWXUG4nBTXDAByzby5YIttJ34HrXA8WPPTJfEHt8Wm+xlU45kVeOfuZIg1bvfW3jG5clGfXdT1RkeLqHDEpmQkbsYoWxARozapqEFhDQ+XhhrkU6WwUsCF/T/ICvHvMWX+24Sb9FNkRavZnt5Awz5SaYMRc+WMhaPD2F/nUxwMvaTToAIgRyrhFawE9CwqF4MwDgRo8UAJ5Zkk2O+tnRMqfJm/hNRgDPzRn5dw7D5NIpZUolMVyzZOQsuu1SEg1xfWC3mU7j2YkQHWYWz3v545xX1UkrAWA/rEDFM34Wx5F9DLjF50eXEvsT31hwNTI8oba4IiM5grAeqh5kL49/FNrvd2HVhdbs+v+o/3sdFgaUSU85+T+CModmDBD4bVWVi2SW+97+UoluqwRZwR20An2YqM3oK9B/yOwH5k=
  - secure: ResAOa0LxWZtNx22n6TPhMOMEFxSQV/New6q19TZdNwILbsat3i/SJaVDVNSINtmhrdFejrG1V9FxtHZbv1T4gg5v7V6asRidyWSRfH1ciZVHb349MEr01ywnyvQyuxFHtv7JFynpf4mAkSfHPu+2gcdgaHXL1AAxrF+jHzpJZbGLpefGLgwzD7dMtlOoNt16e3eWV9GzmjlTOWaoekn9/rerEO1wfSdsPJKPfVI/ZO/KmVS9KmaRflisSNPB869tdsKOSpEsgpgmv4zyx+W2nqMbAf4164qz2d9KoG9g6LcFB0KaSN/i48w+YJeUBGP6daBPH+dI8unIEX8Yer/A8G9T3YqAcFcxfySVLG6PqIr5qLMBihVcDXan3YVaSfY7EIYAbVkHGEC+YudML9AYUB9tpWOCFv2uzNCTxkXNe+/x59gl6h2dMcdSb+ZMYmITR1wCbfzNFe19kbnFbr9CLuFxJIemvPQ9GEUX9XzWDes4F+Hfk0K4GyPmCicXcyFm7oF0Ipb57SXMcTO22HE6SeXqHrOL/c+iCrlJNs4BnNp1UMt+qBKYpJd2A/HRrTC6iT7/WVotnEBAv1IRquyfdMtC3fU5ZurIjk9pnFCD9f1ljvchCQOdJPlYzKezcfkQWkAfD0/2hjUTf44AgEjnVLx8yfkC6eY7hCMLfArSro=
  - secure: iwRslRlpEkjxFt1NFGxpVopp5kpc+L4Y48erD1oaIHn2OTY2sw5aMh7Iq6ApLFC4wAyKpTd6+5B8smdKkfuuD/G3QUfoXOoxVzQ8o3rfcsTyiSSkS9JlZzDXHUrncerQJmk0aXednRL5ne1H/32eK9XTx5PMvwwRJ2P7ZGN51aiDt+uDeCxxbMHx8nJaK5NeovPuwCN9Mo5rokREH3QF10oemCxzBreqz8juOSl6fIyFiVkZTS34hr1KiHAu6jIBqZ2QyiHUYrMzgs07l3NUFiyeAk1uP78QkW6tqcE+u2b7hktVNZAGkPCakr2INsa4h+yHZjyFwuutx9kalCzqGZRQCV/j7EJDLfJuolrg2wmVznDKDQOoTZ3dbcPFAwSjL7XdvPshmXej/xR2MN0pIj3R7spM+VwnPnwUzYwINjRlYsDGE7bptTSxKwKuN+dvOZFmci6zYuPL1t7vfEZhJhi6Fqnn3TiJ5Un/fbaVSXMH3TT71IiA94FG7svPu+7+3ADpnqbEfWtfm5MPvhgkSqXH6TM0UZnKPTFfSXIM56R40bCwPC8MzLyy75w9PIKHKb93OAgAfv0mMdCU/bQzeLaQJous3LM716F7g5EIXB6c2jPhW/ayogXIH5shQ0OyUUU5kN3McXd1n4716Wp6XT54L2KwZrFZ/7tdysKwIiY=
after_failure:
  - git status
  - git diff
